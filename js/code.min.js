//common
window.onload = function() {
  function isShareUrl(data){
     return (data == "" || data == undefined || data == null || data == 0);
  }
  var shopId = "<?php echo $shopid ?>";
  var shareUrl = "<?php echo $shareurl ?>":
  var shopName = "<?php echo $store->name?>";
  var isFromShreUrl = false;
  var fromUrl = "<?php echo $sid ?>";
  var fromSelf = "<?php echo $id ?>";
  if(!isShreUrl(fromUrl) || fromSelf != fromUrl){
    isFromShreUrl = true;
  }
  var isAttention = false;
  // 获取是否粉丝
  $.ajax({
            type:'post',
            url: '<?php echo Yii::$app->request->baseUrl. '/index.php?r=mob/isfans' ?>',
            //url: 'index.php?r=/mob/isfans',
            //data:JSON.stringify(data),
            dataType:'json',
            success:function(msg){
              var data=eval(msg);
              if(data.is_fans == 1){
                isAttention = true;
              }
              showHtmlData();
            },
            error:function(msg){
              showHtmlData();
            }
        });




  function showHtmlData(){
    var audio;
     //$("#k_ring")[0].play();
    function audioAutoPlay(id){
      audio = document.getElementById(id),
          play = function(){
            audio.play();
            document.removeEventListener("touchstart",play, false);
          };
      audio.play();
      document.addEventListener("WeixinJSBridgeReady", function () {
        play();
      }, false);
      document.addEventListener('YixinJSBridgeReady', function() {
        play();
      }, false);
      document.addEventListener("touchstart",play, false);
    }
    //audioAutoPlay('k_ring');

    document.getElementById("load").style.display = "none";
    //init
    // isLottery();
    var isDelete = false;
    var myswiper= new Swiper("#swiper-container-v", {
      speed: 500,
      direction: "vertical",
      // pagination: ".swiper-pagination",
      mousewheelControl: !0,
      allowSwipeToNext : true,
      allowSwipeToPrev : true,
      // noSwipingClass : 'stop-swiping',
      onInit: function(a) {
          a.myactive = 0;
          for (var b = 0; b < a.slides.length; b++) a.slides[b].style.zIndex = 0;
          a.slides[a.myactive].style.zIndex = 1,
          swiperAnimateCache(a),
          swiperAnimate(a);
      },
      // onSlideChangeEnd: function(swiper){
      //    swiperAnimate(swiper); //每个slide切换结束时也运行当前slide动画
      // },

      onSlideChangeStart: function(swiper){
        swiperAnimate(swiper);
      },
      onSlideChangeEnd:function (swiper) {

      },
      // onTouchEnd:function(swiper){
      //   alert(swiper.activeIndex)
      //   if(swiper.activeIndex!=0){
      //     $(".top-box").addClass("visible");
      //     $(".top-box").removeClass("invisible");
      //   }
      //   swiperAnimate(swiper);
      // },
      onTransitionStart: function(a) {
          a.params.onlyExternal = !0
      },
      onTransitionEnd: function(a) {
          a.params.onlyExternal = !1,
          a.myactive = a.activeIndex;
          for (var b = 0; b < a.slides.length; b++) a.slides[b].style.zIndex = 0;
          a.slides[a.myactive].style.zIndex = 1,
          swiperAnimate(a)


      },
      //watchSlidesProgress: !0,
      // onProgress: function(a) {
      //     var b, c, d, e;
      //     for (a.myactive || (a.myactive = 0), b = 0; b < a.slides.length; b++) c = a.slides[b],
      //     es = c.style,
      //     d = c.progress,
      //     e = d * a.height,
      //     opacity = 0,
      //     b == a.myactive && (opacity = 1 - Math.abs(d) / 2),
      //     (a.slides[a.myactive].progress > 0 && b == a.myactive + 1 || a.slides[a.myactive].progress < 0 && b == a.myactive - 1) && (opacity = .5 + Math.abs(.5 * a.slides[a.myactive].progress)),
      //     c.style.opacity = opacity,
      //     b != a.myactive && (es.webkitTransform = es.MsTransform = es.msTransform = es.MozTransform = es.OTransform = es.transform = "translate3d(0," + e + "px,0)")
      // },
      onSetTransition: function(a, b) {
          for (var c = 0; c < a.slides.length; c++) es = a.slides[c].style,
          es.webkitTransitionDuration = es.MsTransitionDuration = es.msTransitionDuration = es.MozTransitionDuration = es.OTransitionDuration = es.transitionDuration = b + "ms"
      }
    });

    $('.layerdiv').bind('touchend',function(event){
       event.stopPropagation();
       var isHave = $('.share_div').hasClass('hide');
       if(!isHave){
         $('.layerdiv').addClass('hide');
       }
    });

    $('.page2_share_btn').bind('touchend',function(event){
      $('.layerdiv').removeClass('hide');
      $('.qrCode_div').addClass('hide');
      $('.qr_content_div').addClass('hide');
      $('.layer_help_btn').addClass('hide');
      $('.layer_want_btn').addClass('hide');
      $('.share_div').removeClass('hide');
    });

    if(!isFromShreUrl){
      if(!isAttention){
        $('.layerdiv').removeClass('hide');
        $('.qrCode_div').removeClass('hide');
        $('.qr_content_div').removeClass('hide');
        $('.layer_help_btn').addClass('hide');
        $('.layer_want_btn').addClass('hide');
        $('.share_div').addClass('hide');
      }else{
        $('.layerdiv').addClass('hide');
      }
    }else{
      if(!isAttention){
        $('.layerdiv').removeClass('hide');
        $('.qrCode_div').removeClass('hide');
        $('.qr_content_div').addClass('hide');
        $('.layer_help_btn').removeClass('hide');
        $('.layer_want_btn').removeClass('hide');
        $('.share_div').addClass('hide');
        $('.layer_help_btn').bind('touchend',function(event){
           $('.qr_content_div').removeClass('hide');
           $('.layer_help_btn').addClass('hide');
           $('.layer_want_btn').addClass('hide');
        });
        $('.layer_want_btn').bind('touchend',function(event){
           $('.qr_content_div').removeClass('hide');
           $('.layer_help_btn').addClass('hide');
           $('.layer_want_btn').addClass('hide');
        });
        $('.layer_close').bind('touchend',function(event){
           $('.qr_content_div').removeClass('hide');
           $('.layer_help_btn').addClass('hide');
           $('.layer_want_btn').addClass('hide');
        });
      }else{
        $('.layerdiv').removeClass('hide');
        $('.qrCode_div').removeClass('hide');
        $('.qr_content_div').addClass('hide');
        $('.layer_help_btn').removeClass('hide');
        $('.layer_want_btn').removeClass('hide');
        $('.layer_help_btn').bind('touchend',function(event){
           $('.layerdiv').addClass('hide');
           getHelp();
        });
        $('.layer_want_btn').bind('touchend',function(event){
           $('.layerdiv').addClass('hide');
        });
      }
    }


  function getHelp(){
    $.ajax({
          type:'post',
          url: '<?php echo Yii::$app->request->baseUrl. '/index.php?r=mob/helpfriend' ?>',
          //url: 'index.php?r=/mob/isfans',
          //data:JSON.stringify(data),
          dataType:'json',
          success:function(msg){
            // var data=eval(msg);
            // console.log(data);
          },
          error:function(msg){
            // console.log(msg);
          }
      });
  }

  $('.page1_pick_btn').bind('touchend',function(event){
     pick();
  });

  function pick(){
    $.ajax({
              type:'post',
              url: '<?php echo Yii::$app->request->baseUrl. '/index.php?r=mob/helpcount' ?>',
              //url: 'index.php?r=/mob/isfans',
              //data:JSON.stringify(data),
              dataType:'json',
              success:function(msg){
                console.log(msg);
                console.log("1111");
                var dataInfo=eval(msg);
                if(dataInfo.status == 1){
                  pickResult(dataInfo.data);
                }else{
                  alert("领取失败，请稍后重试");
                }
              },
              error:function(msg){
                alert("领取失败，请稍后重试");
              }
        });
  }

  function pickResult(numCode){
    myswiper.slideNext();
    for (var i = 1; i <= numCode; i++) {
      if(i == 1){
        $('#page2_icon1').attr("src",'images/2/book_circle.png');
        $('#page2_icon1').addClass('thisRotate');
        $('.page2_book').addClass('ThisScale');
      }else if(i == 2){
        $('#page2_icon2').attr("src",'images/2/book_circle.png');
        $('#page2_icon2').addClass('thisRotate');
        $('.page2_icon2').addClass('ThisScale');
      }else if(i == 3){
        $('#page2_icon3').attr("src",'images/2/book_circle.png');
        $('#page2_icon3').addClass('thisRotate');
        $('.page2_icon3').addClass('ThisScale');
      }else if(i == 4){
        $('#page2_icon4').attr("src",'images/2/book_circle.png');
        $('#page2_icon4').addClass('thisRotate');
        $('.page2_icon4').addClass('ThisScale');
      }else if(i == 5){
        $('#page2_icon5').attr("src",'images/2/book_circle.png');
        $('#page2_icon5').addClass('thisRotate');
        $('.page2_icon5').addClass('ThisScale');
      }
    }
  }
  }

};
